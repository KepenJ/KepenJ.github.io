<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>Supporting IPv6 | Log'K'</title><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/4.2.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/grids-responsive-min.css"><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.0.0/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Supporting IPv6</h1><a id="logo" href="/.">Log'K'</a><p class="description">Learn more.</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">Supporting IPv6</h1><div class="post-meta">May 22, 2016<span> | </span><span class="category"><a href="/categories/iOS/">iOS</a></span><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> Hits</span></span></div><div class="post-content"><a id="more"></a>
<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>WWDC 2015 中 Apple 提到了 iOS9 之后将全面兼容 IPv6 ，毕竟 IPv4 也就是我们现在使用的 IP 地址已经枯竭，<a href="https://en.wikipedia.org/wiki/Network_address_translation" target="_blank" rel="external">NAT 技术</a>也是治标不治本，于是 Apple 爸爸也叫要求广大开发者同样要适配 IPv6 网络，毕竟这是一个趋势就如同 Swift 注定将成为以后 iOS 开发的语言而不是 OC。</p>
<p>当然爸爸给我们的最后期限是 2016.6.1 同时也给出了相关文档 Supporting IPv6 DNS64/NAT64 Networks ，想了解详细内容的同学可以参考这个文档。</p>
<h2 id="DNS64-NAT64-Networks"><a href="#DNS64-NAT64-Networks" class="headerlink" title="DNS64/NAT64 Networks"></a>DNS64/NAT64 Networks</h2><p>下图就是我们之前的 iOS 设备传统网络的接入方式，你会发现 IPv4 和 IPv6 的接入都是单独的连接方式，毕竟让全球或者大多数互联网公司全部从 IPv4 转换成 IPv6 这个成本就不可估量。</p>
<p><img src="https://raw.githubusercontent.com/KepenJ/BlogImages/master/ipv6/1.png" alt="1.1"></p>
<p>所以一种新的网络接入方式改良了这个方案，这个就是我们之后的 <code>DNS64/NAT64</code></p>
<p><img src="https://raw.githubusercontent.com/KepenJ/BlogImages/master/ipv6/2.png" alt="1.2"></p>
<p>下图是关于 DNS64/NAT64 相关流程的介绍</p>
<p><img src="https://raw.githubusercontent.com/KepenJ/BlogImages/master/ipv6/3.png" alt="1.3"></p>
<h2 id="我们开发者要怎么做？"><a href="#我们开发者要怎么做？" class="headerlink" title="我们开发者要怎么做？"></a>我们开发者要怎么做？</h2><p>至于你问我 iOS 开发者需要在项目中去做什么呢？这几条应该能解答你的疑问，毕竟这几条也是苹果提出的。</p>
<h3 id="使用高级网络框架"><a href="#使用高级网络框架" class="headerlink" title="使用高级网络框架"></a>使用高级网络框架</h3><p>这里的高级网络框架指的当然是 Apple 自己的</p>
<ul>
<li>WebKit</li>
<li>Cocoa URL loading system</li>
<li>CFNetwork</li>
</ul>
<p>可不要理解成一些第三方的如 <code>AFNetworking</code> 一类的，应为其他第三方的网络框架也是基于这些去编写的。Apple 这些提供的网络框架已经帮你做好的相关兼容，所以开发者其实并不需要再代码里面再做什么改变了。</p>
<p>区别于高级网络框架，更底层的一些才是我们需要注意到的，这个就放到下面的 消除 <code>IPv4-specific API</code> 兼容 <code>IPv6</code> 里面来具体说明。</p>
<p>总之如果你项目中使用的是一些大型网络框架，例如 AFNetworking 一类的那么正常的网络请求是不需要你操心或者更改什么的。</p>
<h3 id="不要使用-IP-地址"><a href="#不要使用-IP-地址" class="headerlink" title="不要使用 IP 地址"></a>不要使用 IP 地址</h3><p>这里更多的是针对 Apple 的 SCNetworkReachability 这个类来讲的，这个类被苹果用来检测网络状态想要了解细节的同学可以看 SCNetworkReachability参考。</p>
<p>因为一般我们发起网络请求的时候是通过创建 Request 对象来发起请求连接，而其中的 URL 的内容，Apple 告诫开发者尽量不要直接使用 IP 地址作为 URL 的内容，而应该使用域名访问的方式来操作。当然这一点不会影响到我们的正常开发，你可以当做是 Apple 的一个善意规劝吧。</p>
<h3 id="连接而无需预测"><a href="#连接而无需预测" class="headerlink" title="连接而无需预测"></a>连接而无需预测</h3><p>还是 SCNetworkReachability 这块的问题，毕竟这个类属于底层对象，有好多对象方法并没有做 IPv4 和 IPv6 的适配例如其中的 gethostbyname 或者 gethostbyname2 或者使用 INET_ATON等等，或许是 Apple 爸爸偷懒了吧，总之Apple 爸爸也想规劝开发者不要再发起请求前先判断当前的网络状态情况了，坦然的面对网络失效而导致的请求失败吧…[手动滑稽]</p>
<h3 id="消除-IPv4-specific-API-兼容-IPv6"><a href="#消除-IPv4-specific-API-兼容-IPv6" class="headerlink" title="消除 IPv4-specific API 兼容 IPv6"></a>消除 IPv4-specific API 兼容 IPv6</h3><p>Apple 还给我们提供了一个 IPv4 转化成 IPv6 的系统方法，目的是为了解决 IPv4 专用 API 的问题，也是 Apple 开始所不允许的，这个 API 实现代码如下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netdb.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;arpa/inet.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;err.h&gt;</span></span></div><div class="line"><span class="keyword">uint8_t</span> ipv4[<span class="number">4</span>] = &#123;<span class="number">192</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">1</span>&#125;;</div><div class="line"><span class="keyword">struct</span> addrinfo hints, *res, *res0;</div><div class="line"><span class="keyword">int</span> error, s;</div><div class="line"><span class="keyword">const</span> <span class="keyword">char</span> *cause = <span class="literal">NULL</span>;</div><div class="line"><span class="keyword">char</span> ipv4_str_buf[INET_ADDRSTRLEN] = &#123; <span class="number">0</span> &#125;;</div><div class="line"><span class="keyword">const</span> <span class="keyword">char</span> *ipv4_str = inet_ntop(AF_INET, &amp;ipv4, ipv4_str_buf, <span class="keyword">sizeof</span>(ipv4_str_buf));</div><div class="line"><span class="built_in">memset</span>(&amp;hints, <span class="number">0</span>, <span class="keyword">sizeof</span>(hints));</div><div class="line">hints.ai_family = PF_UNSPEC;</div><div class="line">hints.ai_socktype = SOCK_STREAM;</div><div class="line">hints.ai_flags = AI_DEFAULT;</div><div class="line">error = getaddrinfo(ipv4_str, <span class="string">"http"</span>, &amp;hints, &amp;res0);</div><div class="line"><span class="keyword">if</span> (error) &#123;</div><div class="line">    errx(<span class="number">1</span>, <span class="string">"%s"</span>, gai_strerror(error));</div><div class="line">    <span class="comment">/*NOTREACHED*/</span></div><div class="line">&#125;</div><div class="line">s = <span class="number">-1</span>;</div><div class="line"><span class="keyword">for</span> (res = res0; res; res = res-&gt;ai_next) &#123;</div><div class="line">    s = socket(res-&gt;ai_family, res-&gt;ai_socktype,</div><div class="line">               res-&gt;ai_protocol);</div><div class="line">    <span class="keyword">if</span> (s &lt; <span class="number">0</span>) &#123;</div><div class="line">        cause = <span class="string">"socket"</span>;</div><div class="line">        <span class="keyword">continue</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (connect(s, res-&gt;ai_addr, res-&gt;ai_addrlen) &lt; <span class="number">0</span>) &#123;</div><div class="line">        cause = <span class="string">"connect"</span>;</div><div class="line">        close(s);</div><div class="line">        s = <span class="number">-1</span>;</div><div class="line">        <span class="keyword">continue</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">break</span>;  <span class="comment">/* okay we got one */</span></div><div class="line">&#125;</div><div class="line"><span class="keyword">if</span> (s &lt; <span class="number">0</span>) &#123;</div><div class="line">    err(<span class="number">1</span>, <span class="string">"%s"</span>, cause);</div><div class="line">    <span class="comment">/*NOTREACHED*/</span></div><div class="line">&#125;</div><div class="line">freeaddrinfo(res0);</div></pre></td></tr></table></figure>
<h3 id="如何进行-IPv6-相关测试"><a href="#如何进行-IPv6-相关测试" class="headerlink" title="如何进行 IPv6 相关测试"></a>如何进行 IPv6 相关测试</h3><p>好啦，这块我就偷懒直接翻译并使用 Apple 提供的方法和截图了，相信大家明眼一看就懂，无需过多的解释（逃。。。。</p>
<ol>
<li>首先确保你的 MAC 设备不通过WIFI连接上网络。</li>
<li>打开设置</li>
<li>打开分享，不要松开 <code>Option</code> 键。<br><img src="https://raw.githubusercontent.com/KepenJ/BlogImages/master/ipv6/6.png =500x" alt="1.4"></li>
<li>在共享服务列表中选择 <code>Internet</code> 共享。<br><img src="https://raw.githubusercontent.com/KepenJ/BlogImages/master/ipv6/7.png =500x" alt="1.5"></li>
<li>松开 <code>Option</code> 键</li>
<li>选择创建 <code>NAT64</code> 网络复选框<br><img src="https://raw.githubusercontent.com/KepenJ/BlogImages/master/ipv6/8.png =500x" alt="1.6"></li>
<li>选择网络接口，提供您的 Internet 连接，如以太网。<br><img src="https://raw.githubusercontent.com/KepenJ/BlogImages/master/ipv6/9.png =500x" alt="1.7"></li>
<li><p>选择了 <code>Wi-Fi</code> 复选框。<br><img src="https://raw.githubusercontent.com/KepenJ/BlogImages/master/ipv6/10.png =500x" alt="1.8"></p>
</li>
<li><p>单击 Wi-Fi 选项，并配置为您的网络的网络名称和安全选项。<br><img src="https://raw.githubusercontent.com/KepenJ/BlogImages/master/ipv6/11.png =500x" alt="1.9"><br><img src="https://raw.githubusercontent.com/KepenJ/BlogImages/master/ipv6/12.png =500x" alt="2.0"></p>
</li>
<li><p>选择 Internet 共享复选框启用本地网络。<br><img src="https://raw.githubusercontent.com/KepenJ/BlogImages/master/ipv6/13.png =500x" alt="2.1"></p>
</li>
<li><p>当系统提示您确认您要开始共享，单击开始。<br><img src="https://raw.githubusercontent.com/KepenJ/BlogImages/master/ipv6/14.png =500x" alt="2.2"></p>
</li>
<li><p>一旦共享处于活动状态，你应该看到一个绿色的状态指示灯，并且说，Internet共享标签：开。在无线网络菜单中，您还将看到一个小的，淡淡的箭头朝上，表明互联网共享已启用。你现在有一个IPv6 NAT64网络，并可以从其他设备，以测试你的应用程序连接到它。<br><img src="https://raw.githubusercontent.com/KepenJ/BlogImages/master/ipv6/15.png =300x" alt="2.3"></p>
</li>
</ol>
</div><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a data-url="http://yoursite.com/2016/05/22/Supporting-IPv6/" data-id="cis8ow5qu000p4nu5k3ol3rw0" class="article-share-link">分享到</a><div class="tags"></div><div class="post-nav"><a href="/2016/05/28/C-学习笔记（三）：继承和派生/" class="pre">C++学习笔记（三）：继承和派生</a><a href="/2016/05/21/C-学习笔记（二）：类和对象/" class="next">C++学习笔记（二）：类和对象</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/C/">C++</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Hexo/">Hexo</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Python/">Python</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/iOS/">iOS</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/杂感/">杂感</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最新文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2016/06/20/Github-代码阅读杂感——AFNetworking/">Github 代码阅读杂感——AFNetworking</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/06/05/C-学习笔记（六）：模板、字符串和异常/">C++学习笔记（六）：模板、字符串和异常</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/06/03/C-学习笔记（五）：运算符重载/">C++学习笔记（五）：运算符重载</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/06/01/C-学习笔记（四）：多态性与虚函数/">C++学习笔记（四）：多态性与虚函数</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/05/28/C-学习笔记（三）：继承和派生/">C++学习笔记（三）：继承和派生</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/05/22/Supporting-IPv6/">Supporting IPv6</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/05/21/C-学习笔记（二）：类和对象/">C++学习笔记（二）：类和对象</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/04/27/C-学习笔记（一）：C-基本和新增特性/">C++学习笔记（一）：C++基本和新增特性</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/04/21/iAP-的一波玩弄/">iAP 的一波玩弄</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/04/20/A-new-beginning/">A new beginning.</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="https://github.com/KepenJ" title="Github" target="_blank">Github</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">© <a href="/." rel="nofollow">Log'K'.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="/css/jquery.fancybox.css?v=0.0.0"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>