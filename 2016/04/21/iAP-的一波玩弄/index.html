<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>iAP 的一波玩弄 | Log'K'</title><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/4.2.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/grids-responsive-min.css"><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.0.0/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">iAP 的一波玩弄</h1><a id="logo" href="/.">Log'K'</a><p class="description">Learn more.</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">iAP 的一波玩弄</h1><div class="post-meta">Apr 21, 2016<span> | </span><span class="category"><a href="/categories/iOS/">iOS</a></span><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> Hits</span></span></div><div class="post-content"><a id="more"></a>
<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>昨天入职猎豹，今天就急不可耐的上手项目了。上来的第一个需求就是 iAP 相关的一波需求。这一波流程下来也暴露了自己的一些不足和挖掘出了一些个人感觉 Apple 相关的不足之处。<br>po🐷之前也是自己玩的时候整过 iAP 的 Demo，可是这次的需求则是如何在游戏当中添加VIP自动续订的功能。当然这个功能 Android 的小伙伴们已经实现了，而自己则是第一次碰到这样的问题。</p>
<h2 id="什么是-iAP"><a href="#什么是-iAP" class="headerlink" title="什么是 iAP"></a>什么是 iAP</h2><p>iAP (In-App Purchase) 是 Apple 提供给我们开发者用于自身应用内部支付的一个框架。通过在 iTunesConnect 后台管理中添加你所希望销售的产品，可以通过 Apple 提供的 Store Kit 框架来实现简单地 iAP 支付流程。</p>
<p>正常的 iAP 流程包含了 Apple 服务器端、App 端和自身 Server 端。正如下 Apple 提供给我的流程图</p>
<p><img src="https://raw.githubusercontent.com/KepenJ/BlogImages/master/iap/1.png" alt="1.1"></p>
<p>整个流程大致包含了以下几点，App端的：</p>
<ol>
<li>登录账号</li>
<li>获取商品ID</li>
<li>验证商品ID有效性</li>
<li>创建一个付款请求</li>
<li>收到付款回执单</li>
<li>将回执单发送至自身 Server 进行安全校验</li>
<li>通知 App 端验证结果</li>
<li>完成购买</li>
</ol>
<p>当然苹果也给了我们一个简单流程描述图：</p>
<p><img src="https://raw.githubusercontent.com/KepenJ/BlogImages/master/iap/2.png" alt="1.2"></p>
<h2 id="实现一个简单的-iAP"><a href="#实现一个简单的-iAP" class="headerlink" title="实现一个简单的 iAP"></a>实现一个简单的 iAP</h2><h3 id="1-创建我们要销售的产品"><a href="#1-创建我们要销售的产品" class="headerlink" title="1. 创建我们要销售的产品"></a>1. 创建我们要销售的产品</h3><p>首先你需要去 <a href="https://itunesconnect.apple.com/" target="_blank" rel="external">iTunes Connect</a> 当中创建一个新的 App 或者使用以前的 App 也可以，在这里po🐷就新创建了一个Demo用的 App。</p>
<p><img src="https://raw.githubusercontent.com/KepenJ/BlogImages/master/iap/3.png" alt="1.3"></p>
<p>当我们进入我们的 App 的时候，只需要在功能一项中的 App内购买项目 中你会发现我之前已经创建好的一个内购需求</p>
<p><img src="https://raw.githubusercontent.com/KepenJ/BlogImages/master/iap/4.png" alt="1.4"></p>
<p>OK，我们只需要点击上面那个 + 按钮即可开始添加我们的新项目。因为我们的开发者账号部分协议问题，现在只能创建 免费 类型的商品。如果你想添加其他类型的商品信息，只需要去 协议、税务和银行业务 去更改相关的账户银行卡、账单地址信息并同意相关条款即可。</p>
<p><img src="https://raw.githubusercontent.com/KepenJ/BlogImages/master/iap/5.png" alt="1.5"></p>
<p>接下来就是填写产品的信息，下面是我们已经填写好的产品信息</p>
<p><img src="https://raw.githubusercontent.com/KepenJ/BlogImages/master/iap/6.png" alt="1.6"></p>
<p>下来就是相关产品的介绍和截图，这里po🐷并未提供相关截图信息，也正如上图所示 Waiting for Screenshot 。因为 Apple 需要所有的内购商品都要提供所测试用的账号名密码和相关支付时候的截图信息以供审核使用。所以你要想能让你的 App 可以正常使用iAP功能还是老老实实遵守的好。当然这个不会影响我们的正常开发。</p>
<p><img src="https://raw.githubusercontent.com/KepenJ/BlogImages/master/iap/7.png" alt="1.7"></p>
<p>当上述这些都编辑完后，点击保存一个内购产品就成功创建了。</p>
<h3 id="2-App-中加入-iAP-测试我们的产品"><a href="#2-App-中加入-iAP-测试我们的产品" class="headerlink" title="2. App 中加入 iAP 测试我们的产品"></a>2. App 中加入 iAP 测试我们的产品</h3><p>OK，接下来我们就要实现上面提到的整个流程的那几步：</p>
<p>首先我们需要向我们的项目中导入 <code>StroreKit.framework</code> Apple 的内购就是通过这个框架进行的。<br>我们需要判断当前设备是否支持内购支付，毕竟模拟器是不允许进行内购的</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[<span class="built_in">SKPaymentQueue</span> canMakePayments]</div></pre></td></tr></table></figure>
<p>下来就是拉取我们的产品的信息，也就是我们之前在 iTunes Connect 后台创建的那些。当然你也可以将之前创建的 Product ID 写死在本地，但是你得确保本地写的这个跟后他设定好的匹配到一起，不然还是无法进行购买的。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">-(<span class="keyword">void</span>)requestProductData:(<span class="built_in">NSString</span>*)buyProductIDTag</div><div class="line">&#123;</div><div class="line">    <span class="built_in">NSArray</span> *product = [[<span class="built_in">NSArray</span> alloc] initWithObjects:buyProductIDTag,<span class="literal">nil</span>];</div><div class="line">    <span class="built_in">NSSet</span> *nsset = [<span class="built_in">NSSet</span> setWithArray:product];</div><div class="line">    <span class="built_in">SKProductsRequest</span> *request=[[<span class="built_in">SKProductsRequest</span> alloc] initWithProductIdentifiers: nsset];</div><div class="line">    request.delegate=<span class="keyword">self</span>;</div><div class="line">    [request start];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>我们需要实现 <code>SKProductsRequest</code> 的回调</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">- (<span class="keyword">void</span>)productsRequest:(<span class="built_in">SKProductsRequest</span> *)request didReceiveResponse:(<span class="built_in">SKProductsResponse</span> *)response&#123;</div><div class="line"></div><div class="line">    <span class="comment">//这里回调的的就是抓取下拉的 Product 信息。</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>OK，当我们拿到了内购的产品信息后，接下来就是要发起一个支付请求了，需要注意的是在我们发起请求之前，我们需要給 <code>SKPaymentQueue</code> 添加一个账单的监听者。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[[<span class="built_in">SKPaymentQueue</span> defaultQueue] addTransactionObserver:<span class="keyword">self</span>];</div></pre></td></tr></table></figure>
<p>之后我们就可以使用之前请求道德 Product ID 进行商品的购买了</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">SKPayment</span> * payment = [<span class="built_in">SKPayment</span> paymentWithProduct:buyProductIDTag];</div><div class="line">[[<span class="built_in">SKPaymentQueue</span> defaultQueue] addPayment:payment];</div></pre></td></tr></table></figure>
<p>同样我们需要实现 SKPaymentTransactionObserver 的方法</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">- (<span class="keyword">void</span>)paymentQueue:(<span class="built_in">SKPaymentQueue</span> *)queue updatedTransactions:(<span class="built_in">NSArray</span>&lt;<span class="built_in">SKPaymentTransaction</span> *&gt; *)transactions &#123;</div><div class="line">	<span class="comment">//这里就是交易成功后的账单回调</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这里有必要说说回调方法中的 <code>transactions</code> ，因为这个回调对象中包含了一个 <code>transactionState</code> 属性，而当前这个属性别用来判断这个账单的状态</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">SKPaymentTransactionStatePurchasing // 当前账单正在被添加到服务器队列中</div><div class="line">SKPaymentTransactionStatePurchased // 账单已经完成</div><div class="line">SKPaymentTransactionStateFailed // 加入服务器队列失败或者用户取消了该账单</div><div class="line">SKPaymentTransactionStateRestored // 该账单已经是购买状态，客户端应恢复之前状态</div><div class="line">SKPaymentTransactionStateDeferred //最终状态未确定，等待进一步操作</div></pre></td></tr></table></figure>
<p>当然我们常用到的也就是<code>SKPaymentTransactionStatePurchased</code>,<code>SKPaymentTransactionStateFailed</code>,<code>SKPaymentTransactionStateRestored</code> 这三个状态来进行之后的逻辑。</p>
<h3 id="3-关于服务器校验"><a href="#3-关于服务器校验" class="headerlink" title="3. 关于服务器校验"></a>3. 关于服务器校验</h3><p>这里苹果也给出了两个接口，AppStore线上的购买凭证验证地址是<a href="https://buy.itunes.apple.com/verifyReceipt" target="_blank" rel="external">https://buy.itunes.apple.com/verifyReceipt</a> ，测试的验证地址是：<a href="https://sandbox.itunes.apple.com/verifyReceipt" target="_blank" rel="external">https://sandbox.itunes.apple.com/verifyReceipt</a>，我们只需要在当前为 <code>SKPaymentTransactionStatePurchased</code> 情况下去上传账单。</p>
<p>当我们服务器验证无误回调给我们的时候，这次购买流程才算是成功了。</p>
</div><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a data-url="http://yoursite.com/2016/04/21/iAP-的一波玩弄/" data-id="cis8ow5r5000u4nu5wkpjq3fl" class="article-share-link">分享到</a><div class="tags"></div><div class="post-nav"><a href="/2016/04/27/C-学习笔记（一）：C-基本和新增特性/" class="pre">C++学习笔记（一）：C++基本和新增特性</a><a href="/2016/04/20/A-new-beginning/" class="next">A new beginning.</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/C/">C++</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Hexo/">Hexo</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Python/">Python</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/iOS/">iOS</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/杂感/">杂感</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最新文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2016/06/20/Github-代码阅读杂感——AFNetworking/">Github 代码阅读杂感——AFNetworking</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/06/05/C-学习笔记（六）：模板、字符串和异常/">C++学习笔记（六）：模板、字符串和异常</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/06/03/C-学习笔记（五）：运算符重载/">C++学习笔记（五）：运算符重载</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/06/01/C-学习笔记（四）：多态性与虚函数/">C++学习笔记（四）：多态性与虚函数</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/05/28/C-学习笔记（三）：继承和派生/">C++学习笔记（三）：继承和派生</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/05/22/Supporting-IPv6/">Supporting IPv6</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/05/21/C-学习笔记（二）：类和对象/">C++学习笔记（二）：类和对象</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/04/27/C-学习笔记（一）：C-基本和新增特性/">C++学习笔记（一）：C++基本和新增特性</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/04/21/iAP-的一波玩弄/">iAP 的一波玩弄</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/04/20/A-new-beginning/">A new beginning.</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="https://github.com/KepenJ" title="Github" target="_blank">Github</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">© <a href="/." rel="nofollow">Log'K'.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="/css/jquery.fancybox.css?v=0.0.0"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>