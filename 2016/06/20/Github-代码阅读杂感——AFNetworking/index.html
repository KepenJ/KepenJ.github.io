<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>Github 代码阅读杂感——AFNetworking | Log'K'</title><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/4.2.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/grids-responsive-min.css"><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.0.0/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Github 代码阅读杂感——AFNetworking</h1><a id="logo" href="/.">Log'K'</a><p class="description">Learn more.</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">Github 代码阅读杂感——AFNetworking</h1><div class="post-meta">Jun 20, 2016<span> | </span><span class="category"><a href="/categories/iOS/">iOS</a></span><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> Hits</span></span></div><div class="post-content"><a id="more"></a>
<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p><a href="https://github.com/AFNetworking/AFNetworking" target="_blank" rel="external">AFNetworking</a> 这个网络框架相信每一个做 iOS 开发的工程师都不陌生，这个正是 <a href="https://github.com/mattt" target="_blank" rel="external">Mattt</a> 大神团队一起开发的。很惭愧的是po🐷做开发到现在，正是因为现在准备开始自己撸一套给自己项目用的网络框架的时候才真真正正的开始细细研究这套框架。</p>
<p>po🐷最早接触的网络框架也是相对较为知名的 <a href="https://allseeing-i.com/ASIHTTPRequest" target="_blank" rel="external">ASIHTTPRequest</a> 这个框架是基于 Apple 的 <code>CoreFoundation</code> 中的 <code>CFNetworking</code> 编写的，可惜的是该项目早在两年前就不再更新，很多 API 已经面临摒弃，无奈之余po🐷只能从而转战 <code>AFNetworking</code>。这次写这篇 blog 目的在于总结一下自己几日来针对“一个好的网络框架”的思考.</p>
<p>当然细节设计这块 <a href="http://nshipster.cn/afnetworking-2/" target="_blank" rel="external">NSHipster 中有关于 AFNetworking 2.0 的细节设计</a>，想了解细节的朋友可以看这个。</p>
<h2 id="整体框架"><a href="#整体框架" class="headerlink" title="整体框架"></a>整体框架</h2><p>AFNetworking 源码里面包含了 核心请求框架 和 各种 <code>Category</code> 两部分内容，其中 核心请求框架 里面也包含针对整个网络请求的创建、发起、接收相应一套流程的封装，算是完全独立出来的一块。下面是截图</p>
<p><img src="https://raw.githubusercontent.com/KepenJ/BlogImages/master/afnetwork/1.png =200x" alt="1.1"></p>
<p>因为我们的网咯请求基本是基于<a href="https://www.google.com.hk/url?sa=t&amp;rct=j&amp;q=&amp;esrc=s&amp;source=web&amp;cd=2&amp;ved=0ahUKEwiWlpyum8rNAhXHnpQKHRISAQQQFgggMAE&amp;url=https%3a%2f%2fzh%2ewikipedia%2eorg%2fzh-cn%2f%25E8%25B6%2585%25E6%2596%2587%25E6%259C%25AC%25E4%25BC%25A0%25E8%25BE%2593%25E5%258D%258F%25E8%25AE%25AE&amp;usg=AFQjCNEIIMRAoymz7wChMCychTYJnw2KbQ" target="_blank" rel="external">HTTP 协议</a>进行的，希望了解更多的朋友可以阅读一下相关的文档。整个网络请求流程大概如下：</p>
<ol>
<li>创建一个 reqeust，同时加入管理；</li>
<li>发起这次请求；</li>
<li>接收 response 相关信息，同时做相关策略操作；</li>
<li>接收并返回相关数据；</li>
</ol>
<p>其中 <code>AFURLRequestSerialization</code> 就是专门用来生成我们 <code>Request</code> 用的类。整个类的功能涵盖简单的网络请求，文件上传请求拼接，header拼接，等等。基本覆盖了咱们整个网络请求创建 request 这个步骤里面的方方面面，当然它输出的也就是一个 request ，以便我们可以将这块的逻辑单独拆分出去。</p>
<p>同理 <code>AFURLResponseSerialization</code> 和 <code>AFURLRequestSerialization</code> 整体设计思路上是一致的，通过将 response 这块拆分出来达到更多可定制化的目的。毕竟 NSURLResponse 有事还是满足不了我们的。</p>
<p>当然针对创建 <code>request -&gt; 发起 -&gt; 收到 response</code> 这个流程是需要单独封装起来管理的，这样 <code>AFURLSessionManager</code> 就诞生了。这个类算是整个源码框架的核心位置，所有的核心逻辑也都是放在这里面用的。说到管理，AFNetworing 设计了么一个 request 都会生成一个单独的<code>AFURLSessionManagerDelegate</code> 这个类对象去管理，同时创建出相关的线程去跑这个流程，毕竟我们不是单单的一次请求，多并发是不可避免的。相关的线程问题和安全也会被考虑进来。</p>
<p>至于 <code>AFSecurityPolicy</code> 则是 AFNetworking 提供给我们做安全链接认证的类。我们传统的安全连接方式主要是以<a href="https://www.google.com.hk/url?sa=t&amp;rct=j&amp;q=&amp;esrc=s&amp;source=web&amp;cd=1&amp;ved=0ahUKEwi6nvviucrNAhUItY8KHYSRAo8QFggaMAA&amp;url=https%3a%2f%2fzh%2ewikipedia%2eorg%2fzh-cn%2f%25E8%25B6%2585%25E6%2596%2587%25E6%259C%25AC%25E4%25BC%25A0%25E8%25BE%2593%25E5%25AE%2589%25E5%2585%25A8%25E5%258D%258F%25E8%25AE%25AE&amp;usg=AFQjCNEwsUqfHc-euahqeNV2nEmHo0GWLg" target="_blank" rel="external">https</a> 为主，想了解相关内容的朋友可以去翻阅相关资料。这里简单说明一下，当我们发起一个 https 的请求链接的时候，每次是需要进行相关的 SSL 证书验证的，只有验证通过的请求才可以进行相关后续的操作，未能验证通过的则抛弃。这个类的主要功能也是围绕这个 “验证证书” 进行的封装和扩展。</p>
<p>最后就是对外暴露的 <code>AFHTTPSessionManager</code>，这个类就是我们封装我们的网络请求所用到的类。当然它也提供给了我们很多 API，什么上传的、下载的和简单地请求的，各种各样的网络请求。当然他的核心实现层是在 <code>AFURLSessionManager</code> 中进行的。通过 block 对调给这个类，再与我们的逻辑层进行交互。</p>
<p>整个框架的作用大概如下吧：</p>
<p><img src="https://raw.githubusercontent.com/KepenJ/BlogImages/master/afnetwork/2.JPG =500x" alt="1.2"></p>
<h2 id="一些思考和赞扬"><a href="#一些思考和赞扬" class="headerlink" title="一些思考和赞扬"></a>一些思考和赞扬</h2><ul>
<li>使用 Block 作为回调。虽然自己跑过 AFNetworking 相关的测试代码，并为查找到相关的内存方面的问题，但是告诫刚接触的朋友 block 尽量不要加入到逻辑当中，虽然它是可以作为回调来使用，但是一旦不注意内存方面的问题，很容易造成内存泄漏。而且如果 block 嵌套一旦过多，或者涉及的逻辑变复杂的话，定位问题和调试也会出现问题。</li>
<li>他们的team真的是非常非常负责人，单就技术而言无可挑剔。同样的该项目的 issues 也被回答的非常彻底，问题也都会得到第一时间解决。</li>
<li>MRC和ARC，最新的 AFNetworking 只支持 ARC 的内存管理模式。如果你的项目还是以前的 MRC 管理方式的话，可能需要你自己手动去适配。</li>
</ul>
</div><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a data-url="http://yoursite.com/2016/06/20/Github-代码阅读杂感——AFNetworking/" data-id="cis8ow5qe000c4nu5ax267ql1" class="article-share-link">分享到</a><div class="tags"></div><div class="post-nav"><a href="/2016/06/05/C-学习笔记（六）：模板、字符串和异常/" class="next">C++学习笔记（六）：模板、字符串和异常</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/C/">C++</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Hexo/">Hexo</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Python/">Python</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/iOS/">iOS</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/杂感/">杂感</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最新文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2016/06/20/Github-代码阅读杂感——AFNetworking/">Github 代码阅读杂感——AFNetworking</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/06/05/C-学习笔记（六）：模板、字符串和异常/">C++学习笔记（六）：模板、字符串和异常</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/06/03/C-学习笔记（五）：运算符重载/">C++学习笔记（五）：运算符重载</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/06/01/C-学习笔记（四）：多态性与虚函数/">C++学习笔记（四）：多态性与虚函数</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/05/28/C-学习笔记（三）：继承和派生/">C++学习笔记（三）：继承和派生</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/05/22/Supporting-IPv6/">Supporting IPv6</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/05/21/C-学习笔记（二）：类和对象/">C++学习笔记（二）：类和对象</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/04/27/C-学习笔记（一）：C-基本和新增特性/">C++学习笔记（一）：C++基本和新增特性</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/04/21/iAP-的一波玩弄/">iAP 的一波玩弄</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/04/20/A-new-beginning/">A new beginning.</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="https://github.com/KepenJ" title="Github" target="_blank">Github</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">© <a href="/." rel="nofollow">Log'K'.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="/css/jquery.fancybox.css?v=0.0.0"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>