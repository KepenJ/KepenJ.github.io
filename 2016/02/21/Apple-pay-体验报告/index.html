<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>Apple pay 体验报告 | Log'K'</title><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/4.2.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/grids-responsive-min.css"><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.0.0/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Apple pay 体验报告</h1><a id="logo" href="/.">Log'K'</a><p class="description">Learn more.</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">Apple pay 体验报告</h1><div class="post-meta">Feb 21, 2016<span> | </span><span class="category"><a href="/categories/iOS/">iOS</a></span><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> Hits</span></span></div><div class="post-content"><a id="more"></a>
<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>之前因为公司项目的原因，耽误了近2各月没有更新 blog（说白了就是忙上了天~各种需求各种改~各种加班各种熬夜 T。T），前天三点才把项目提交了，这阵算是轻松下来了。但是回顾一下之前几个月的情况，自己已经耽误了自己的学习进度，只是勉强寄出点时间更新了自己的算法学习项目<a href="https://github.com/KepenJ/CodeWithLeetcode" target="_blank" rel="external">CodeWithLeetcode</a>。所以趁着现在轻松下来了，继续自己新的一波学习。</p>
<p>回归这篇博文的正题，我们之后要讲到的是14年提出的苹果支付方式 <a href="http://www.apple.com/apple-pay/" target="_blank" rel="external">Apple Pay</a>。就在今年2月18号， Apple Pay 正式进入中国进行服务，po猪也尝了个鲜绑了自己的信用卡，同时尝试了一波美团外卖的支付。截个图，以示庆祝（逃…</p>
<p><img src="https://raw.githubusercontent.com/KepenJ/BlogImages/master/Apple%20pay/1.png" alt="1.1"></p>
<h2 id="Apple-Pay"><a href="#Apple-Pay" class="headerlink" title="Apple Pay"></a>Apple Pay</h2><p>关于如何绑定 Apple Pay 网上已经有很多成型的<a href="http://jingyan.baidu.com/article/495ba84106125238b20ede64.html" target="_blank" rel="external">傻瓜教程</a>了，在这里就不介绍如何绑定自己的信用卡了。至于支付，po猪也是刚刚绑定，并且并未找到北京这块支持 Apple Pay 的线下服务项目。这块就无耻了贴出一个老外的经验贴<a href="http://www.imore.com/how-use-apple-pay-ultimate-guide" target="_blank" rel="external">《How to use Apple Pay: The ultimate guide》</a>。</p>
<p>技术方面苹果也给我们了相关的 <a href="https://developer.apple.com/library/prerelease/ios/ApplePay_Guide/" target="_blank" rel="external">Apple Pay Programming Guide</a> 以下就是我们 Apple Pay 的流程图</p>
<p><img src="https://raw.githubusercontent.com/KepenJ/BlogImages/master/Apple%20pay/2.png" alt="1.2"></p>
<p>同时苹果也给出了我们相关的<a href="https://developer.apple.com/library/prerelease/ios/samplecode/Emporium/Introduction/Intro.html#//apple_ref/doc/uid/TP40016175-Intro-DontLinkElementID_2" target="_blank" rel="external">案例代码</a>，有兴趣的朋友可以去看看，接下来po猪会实际演示一次。</p>
<h2 id="作为开发者，我们如何使用-Apple-Pay"><a href="#作为开发者，我们如何使用-Apple-Pay" class="headerlink" title="作为开发者，我们如何使用 Apple Pay"></a>作为开发者，我们如何使用 Apple Pay</h2><p>扯那么多蛋，下来才开始我们今天的正式内容。既然 Apple Pay 出来了，我们就要开始考虑如何在我们的项目中加入 Apple Pay 的支付。</p>
<h3 id="Merchant-ID-和-相关证书配置"><a href="#Merchant-ID-和-相关证书配置" class="headerlink" title="Merchant ID 和 相关证书配置"></a>Merchant ID 和 相关证书配置</h3><p>首先我们要想让自己的 App 支持 Apple Pay 需要在 <a href="https://developer.apple.com/account/ios/certificate/certificateList.action" target="_blank" rel="external">Member Center</a> 中的 Identifiers 申请 <code>Merchant ID</code>。</p>
<p>申请流程如下图，首先是 Merchant ID 的注册：</p>
<p><img src="https://raw.githubusercontent.com/KepenJ/BlogImages/master/Apple%20pay/4.png" alt="1.3"></p>
<p>苹果貌似针对非美国境内的 Merchant ID 还扩展选项</p>
<p><img src="https://raw.githubusercontent.com/KepenJ/BlogImages/master/Apple%20pay/5.png" alt="1.4"></p>
<p>下来我们要给我么的 App 开启 Apple Pay 的功能，我这块使用的是Demo，所以新建了一个 ApplePayDemo 的项目，同时开启他的 Apple Pay 功能</p>
<p><img src="https://raw.githubusercontent.com/KepenJ/BlogImages/master/Apple%20pay/6.png" alt="1.5"></p>
<p>同时我们还需要申请一个 Apple Pay 的证书，这块从注册好的 Merchant ID 选项里面可以一路创建过去，创建方式跟申请新证书一致，创建 CSR 再去申请新的证书。</p>
<p><img src="https://raw.githubusercontent.com/KepenJ/BlogImages/master/Apple%20pay/11.png" alt="1.6"></p>
<p>过程就不在表述，下为申请好的截图</p>
<p><img src="https://raw.githubusercontent.com/KepenJ/BlogImages/master/Apple%20pay/3.png" alt="1.7"></p>
<p>如果你发现你 Download 下来的证书显示 此证书的签发者无效 的话，你需要重新下载 <a href="https://www.apple.com/certificateauthority/AppleWWDRCAG2.cer" target="_blank" rel="external">Apple Worldwide CA-G2</a> 证书，有区别于之前失效的<a href="https://developer.apple.com/certificationauthority/AppleWWDRCA.cer" target="_blank" rel="external">Apple Worldwide Developer Relations Certification Authority</a>。这里有个 <a href="https://www.apple.com/certificateauthority/pdf/Apple_WWDR_CPS_v1.14.pdf" target="_blank" rel="external">Apple 官方的pdf</a>文件用来讲解这些根证书。</p>
<p>最后，我们需要生成新的 Provisioning Profiles 文件。</p>
<h3 id="Xcode-相关配置"><a href="#Xcode-相关配置" class="headerlink" title="Xcode 相关配置"></a>Xcode 相关配置</h3><p>在项目中，Xcode 相关设置很简单。配置完我们下载好的证书和配置文件之后，在 <code>Capabilities</code> 中开启我们的 Apple Pay ，同时选中我们之前申请好的 Merchant ID</p>
<p><img src="https://raw.githubusercontent.com/KepenJ/BlogImages/master/Apple%20pay/7.png" alt="1.8"></p>
<p>当这些都完成后，你会发现项目文件中多出来了一个 <code>ApplePayDemo.entitlements</code> 文件，这个就是我们 Apple Pay 的授权文件。</p>
<p><img src="https://raw.githubusercontent.com/KepenJ/BlogImages/master/Apple%20pay/8.png" alt="1.9"></p>
<h3 id="创建-Apple-Pay-Request"><a href="#创建-Apple-Pay-Request" class="headerlink" title="创建 Apple Pay Request"></a>创建 Apple Pay Request</h3><p>当我们都配置好 Apple Pay 相关的配置后，接下来才开始正式的代码方面的处理。首先是创建 Apple Pay 的请求发出。（这块我就直接上代码，同时将注释写在了代码当中）</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//检查设备是否支持付款请求</span></div><div class="line"><span class="keyword">if</span>(![PKPaymentAuthorizationViewController canMakePayments]) &#123;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"Have some thing problem."</span>);</div><div class="line">    <span class="keyword">return</span>;</div><div class="line">&#125;</div><div class="line"><span class="comment">//创建 Apple Pay Request</span></div><div class="line">PKPaymentRequest *payment = [[PKPaymentRequest alloc] init];</div><div class="line"><span class="comment">//设置汇率（人民币）</span></div><div class="line">payment.currencyCode = <span class="string">@"CNY"</span>;</div><div class="line"><span class="comment">//国家</span></div><div class="line">payment.countryCode = <span class="string">@"CN"</span>;</div><div class="line"><span class="comment">//Merchant ID</span></div><div class="line">payment.merchantIdentifier = <span class="string">@"merchant.com.kepenj.applepaydemo"</span>;</div><div class="line"><span class="comment">//支持的支付网络（银联/Visa/MasterCard...）</span></div><div class="line">payment.supportedNetworks = @[PKPaymentNetworkAmex,PKPaymentNetworkChinaUnionPay,PKPaymentNetworkDiscover,PKPaymentNetworkVisa,PKPaymentNetworkInterac,PKPaymentNetworkPrivateLabel,PKPaymentNetworkMasterCard];</div><div class="line"><span class="comment">//支持智能卡与可使用芯片卡的POS终端机相应规范（默认 3DS）</span></div><div class="line">payment.merchantCapabilities = PKMerchantCapability3DS | PKMerchantCapabilityEMV;</div><div class="line"><span class="comment">//目录一 12.75 总价</span></div><div class="line"><span class="built_in">NSDecimalNumber</span> *subtotalAmount = [<span class="built_in">NSDecimalNumber</span> decimalNumberWithMantissa:<span class="number">1275</span> exponent:<span class="number">-2</span> isNegative:<span class="literal">NO</span>];</div><div class="line">PKPaymentSummaryItem * subtotal = [PKPaymentSummaryItem summaryItemWithLabel:<span class="string">@"总价"</span> amount:subtotalAmount];</div><div class="line"><span class="comment">//目录二 2.00 折扣</span></div><div class="line"><span class="built_in">NSDecimalNumber</span> *discountAmount = [<span class="built_in">NSDecimalNumber</span> decimalNumberWithMantissa:<span class="number">200</span> exponent:<span class="number">-2</span> isNegative:<span class="literal">YES</span>];</div><div class="line">PKPaymentSummaryItem *discount = [PKPaymentSummaryItem summaryItemWithLabel:<span class="string">@"折扣"</span> amount:discountAmount];</div><div class="line"><span class="comment">//总目录 10.75 总和上述两者</span></div><div class="line"><span class="built_in">NSDecimalNumber</span> *totalAmount = [<span class="built_in">NSDecimalNumber</span> zero];</div><div class="line">totalAmount = [totalAmount decimalNumberByAdding:subtotalAmount];</div><div class="line">totalAmount = [totalAmount decimalNumberByAdding:discountAmount];</div><div class="line">PKPaymentSummaryItem * total = [PKPaymentSummaryItem summaryItemWithLabel:<span class="string">@"KepenJ"</span> amount:totalAmount];</div><div class="line"><span class="comment">//设置支付明细目录</span></div><div class="line">payment.paymentSummaryItems = @[subtotal,discount,total];</div><div class="line"><span class="comment">//弹出 Apple Pay 支付页面</span></div><div class="line">PKPaymentAuthorizationViewController *vc = [[PKPaymentAuthorizationViewController alloc] initWithPaymentRequest:payment];</div><div class="line">vc.delegate = <span class="keyword">self</span>;</div><div class="line">[<span class="keyword">self</span> presentViewController:vc animated:<span class="literal">YES</span> completion:<span class="literal">NULL</span>];</div></pre></td></tr></table></figure>
<p>以上这些就组成了我们最基本的 Apple Pay Request</p>
<h3 id="前端验证支付信息"><a href="#前端验证支付信息" class="headerlink" title="前端验证支付信息"></a>前端验证支付信息</h3><p>当我们支付完成时，我们还需要实现 <code>PKPaymentAuthorizationViewController</code> 的两个代理方法，验证成功</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">- (<span class="keyword">void</span>)paymentAuthorizationViewController:(PKPaymentAuthorizationViewController *)controller didAuthorizePayment:(PKPayment *)payment completion:(<span class="keyword">void</span> (^)(PKPaymentAuthorizationStatus))completion &#123;</div><div class="line">	<span class="comment">//账单信息读取</span></div><div class="line">	ABMultiValueRef addressMultiValue = ABRecordCopyValue(payment.billingAddress, kABPersonAddressProperty);</div><div class="line">	<span class="comment">//生成账单信息的Data</span></div><div class="line">	<span class="built_in">NSDictionary</span> *addressDictionary = (__bridge_transfer <span class="built_in">NSDictionary</span> *) ABMultiValueCopyValueAtIndex(addressMultiValue, <span class="number">0</span>);</div><div class="line">	<span class="built_in">NSData</span> *json = [<span class="built_in">NSJSONSerialization</span> dataWithJSONObject:addressDictionary options:<span class="built_in">NSJSONWritingPrettyPrinted</span> error: &amp;error];</div><div class="line">    <span class="comment">//*****此处省略一万字服务器支付流程*********</span></div><div class="line">    <span class="comment">//验证成功后，你可以用认证成功的 Token 、个人信息、地址等，来进行支付流程也就是你还需要走一套 IAP 支付程序</span></div><div class="line">    <span class="comment">//*****此处省略一万字服务器支付流程*********</span></div><div class="line">	<span class="comment">// 从服务器获取支付后status的结果</span></div><div class="line">	PKPaymentAuthorizationStatus status;  </div><div class="line">	completion(status);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>和结束 <code>PKPaymentAuthorizationViewController</code></p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">- (<span class="keyword">void</span>)paymentAuthorizationViewControllerDidFinish:(PKPaymentAuthorizationViewController *)controller &#123;</div><div class="line">    <span class="comment">//结束PKPaymentAuthorizationViewController</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>最后附上一张结果图</p>
<p><img src="https://raw.githubusercontent.com/KepenJ/BlogImages/master/Apple%20pay/10.jpg =500x" alt="2.0"></p>
<h3 id="至于服务器的处理"><a href="#至于服务器的处理" class="headerlink" title="至于服务器的处理"></a>至于服务器的处理</h3><p>原谅po猪非后台出身，这里po猪就偷懒翻译一下 Apple 官方给出的后台信息处理流程</p>
<ol>
<li><p>首先是接收发送过来的支付信息，连同它的其他订单信息。</p>
</li>
<li><p>验证数据信息的 hash 和 签名。</p>
</li>
<li><p>解密相关数据</p>
</li>
<li><p>向支付网络提交相关支付信息。处理</p>
</li>
<li><p>提交相关指令给你的订单跟踪系统。</p>
</li>
</ol>
<p>当然你可以选择两种方式：一种是使用其他的支付平台来处理上面这些步骤，要么你自己处理。如果你能核实和处理相关信息所涉及到的各种加密逻辑（例如SHA-1 hash、Diffie-Hellman密钥交换等），你大可自己来处理相关内容，如果不能那就换其他的支付平台来帮忙吧。有关支持苹果的收费支付平台的信息，请参考<a href="https://developer.apple.com/apple-pay/" target="_blank" rel="external">developer.apple.com/apple-pay/</a></p>
<p>最后提一下相关相关支付信息的数据结构，其中交互的 Token 隶属于 <code>PKPaymentToken</code> 其结构如下图</p>
<p><img src="https://raw.githubusercontent.com/KepenJ/BlogImages/master/Apple%20pay/12.png" alt="2.1"></p>
</div><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a data-url="http://yoursite.com/2016/02/21/Apple-pay-体验报告/" data-id="cis8pqero00037nu5cevkvhq5" class="article-share-link">分享到</a><div class="tags"></div><div class="post-nav"><a href="/2016/02/29/从-Octopress-换-Hexo-了/" class="pre">从 Octopress 换 Hexo 了</a><a href="/2015/12/29/2015-终总结和-2016-的-flag/" class="next">2015 终总结和 2016 的 flag</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/C/">C++</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Hexo/">Hexo</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Python/">Python</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/iOS/">iOS</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/杂感/">杂感</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最新文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2016/06/20/Github-代码阅读杂感——AFNetworking/">Github 代码阅读杂感——AFNetworking</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/06/05/C-学习笔记（六）：模板、字符串和异常/">C++学习笔记（六）：模板、字符串和异常</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/06/03/C-学习笔记（五）：运算符重载/">C++学习笔记（五）：运算符重载</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/06/01/C-学习笔记（四）：多态性与虚函数/">C++学习笔记（四）：多态性与虚函数</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/05/28/C-学习笔记（三）：继承和派生/">C++学习笔记（三）：继承和派生</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/05/22/Supporting-IPv6/">Supporting IPv6</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/05/21/C-学习笔记（二）：类和对象/">C++学习笔记（二）：类和对象</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/04/27/C-学习笔记（一）：C-基本和新增特性/">C++学习笔记（一）：C++基本和新增特性</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/04/21/iAP-的一波玩弄/">iAP 的一波玩弄</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/04/20/A-new-beginning/">A new beginning.</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="https://github.com/KepenJ" title="Github" target="_blank">Github</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">© <a href="/." rel="nofollow">Log'K'.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="/css/jquery.fancybox.css?v=0.0.0"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>