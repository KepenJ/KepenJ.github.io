<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>深入了解 iOS 中的 Block | Log'K'</title><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/4.2.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/grids-responsive-min.css"><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.0.0/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">深入了解 iOS 中的 Block</h1><a id="logo" href="/.">Log'K'</a><p class="description">Learn more.</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">深入了解 iOS 中的 Block</h1><div class="post-meta">Sep 6, 2015<span> | </span><span class="category"><a href="/categories/iOS/">iOS</a></span><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> Hits</span></span></div><div class="post-content"><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>Block 是我们在 iOS 开发中认识的一个“近似”于函数的一个东西。说是函数因为它们像太多，但是 Block 不是函数，如果要说可以说是针对 C 函数的一个扩充。</p>
<h2 id="我们常见的Block"><a href="#我们常见的Block" class="headerlink" title="我们常见的Block"></a>我们常见的Block</h2><h3 id="为什么说它太像？"><a href="#为什么说它太像？" class="headerlink" title="为什么说它太像？"></a>为什么说它太像？</h3><p>首先是声明</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">int (*func) (int a,int b);</div><div class="line">int (^funOC)(int a, int b);</div></pre></td></tr></table></figure>
<p>都可以这样调用</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">int</span> c = func(<span class="number">1</span>, <span class="number">1</span>);</div><div class="line">    <span class="keyword">int</span> d = funOC(<span class="number">1</span>, <span class="number">1</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>其次他们都可以“访问”外部变量</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span> num1 = <span class="number">1</span>;</div><div class="line"><span class="keyword">static</span> <span class="keyword">int</span> num2 = <span class="number">2</span>;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">funC</span> <span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</div><div class="line">    <span class="built_in">printf</span>(<span class="string">"num1 = %d , num2 = %d"</span>,num1,num2);</div><div class="line">&#125;</div><div class="line"><span class="keyword">void</span> (^funOC)(<span class="keyword">void</span>) = ^ &#123;</div><div class="line">    <span class="built_in">printf</span>(<span class="string">"num1 = %d , num2 = %d"</span>,num1,num2);</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>如果单看表面，的确 Block 中有太多 C 函数的影子。但是当你用多 Block 或者碰到过几次疑难杂症的时候，你就慢慢习惯 Block 不一样的迷人之处。</p>
<h3 id="Block-毕竟不是函数"><a href="#Block-毕竟不是函数" class="headerlink" title="Block 毕竟不是函数"></a>Block 毕竟不是函数</h3><p>首先在声明或者定义的时候你应该就发现了一些区别，是的^这个符号是 Block 特有的。如果说 C 函数的组成结构为</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[返回参数] ＋ [函数声明] ＋ [参数，...] ＋ [表达式]</div></pre></td></tr></table></figure>
<p>那么 Block 就是</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[^] + [参数，...] + [表达式]</div></pre></td></tr></table></figure>
<p>同样的我们可以在 main() 当中去声明一个 Block</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span></div><div class="line">&#123;</div><div class="line"></div><div class="line">    <span class="keyword">int</span> (^funOC) (<span class="keyword">int</span> a, <span class="keyword">int</span> b) = ^(<span class="keyword">int</span> a, <span class="keyword">int</span> b)&#123;</div><div class="line">        <span class="keyword">return</span> a+b;</div><div class="line">    &#125;;</div><div class="line">    <span class="keyword">int</span> c = funOC(<span class="number">1</span>,<span class="number">2</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>但是函数当中却无法再声明其他函数</p>
<p><img src="https://raw.githubusercontent.com/KepenJ/BlogImages/master/Block%20in%20deep/1.png" alt="1.1"></p>
<p>其次就是我们上面讲到的“访问”，C 函数中 我们可以在函数内部访问</p>
<ul>
<li>普通变量</li>
<li>全局变量</li>
<li>局部静态变量</li>
<li>全局静态变量</li>
</ul>
<p>然而在 Block 当中针对“外部访问”这个行为还有些特殊的地方，因为 Block 还有一个特性就是他会截获自动变量的值。举个例子来说明这个特性：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">int</span> a = <span class="number">0</span>;</div><div class="line">    <span class="keyword">void</span> (^funOC)(<span class="keyword">void</span>) = ^&#123;</div><div class="line">        <span class="built_in">printf</span>(<span class="string">"block: a = %d\n"</span>,a);</div><div class="line">    &#125;;</div><div class="line">    a = <span class="number">1</span>;</div><div class="line">    <span class="built_in">printf</span>(<span class="string">"main: a = %d\n"</span>,a);</div><div class="line">    funOC();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>上述代码运行的结果是：</p>
<p><img src="https://raw.githubusercontent.com/KepenJ/BlogImages/master/Block%20in%20deep/2.png" alt="1.2"></p>
<p>当然如果你想在 Block 当中去修改这个截获的自动变量，sorry 这样是行不通的</p>
<p><img src="https://raw.githubusercontent.com/KepenJ/BlogImages/master/Block%20in%20deep/3.png" alt="1.3"></p>
<p>正如错误提示，如果要修改外部变量的值，那么你需要用到 <code>__block</code> 这个说明符，也就是在参数 a 定义前加上 __block 进行说明</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">__block int a = 0;</div></pre></td></tr></table></figure>
<p>更多关于 Block 的用法和介绍可以参照官方文档 <a href="https://developer.apple.com/library/ios/documentation/Cocoa/Conceptual/ProgrammingWithObjectiveC/WorkingwithBlocks/WorkingwithBlocks.html" target="_blank" rel="external">Working with Blocks</a>。</p>
<h2 id="深入-iOS-中的-Block"><a href="#深入-iOS-中的-Block" class="headerlink" title="深入 iOS 中的 Block"></a>深入 iOS 中的 Block</h2><p>粗略的浏览了 iOS 中 Block 的一些知识点，我们再来深入 Block 里面进行浏览吧。</p>
<h3 id="Block-的实现"><a href="#Block-的实现" class="headerlink" title="Block 的实现"></a>Block 的实现</h3><p> Clang 关于 block 的介绍中开源了 block 的内部实现代码：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">struct</span> Block_literal_1 &#123;</div><div class="line"><span class="keyword">void</span> *isa; <span class="comment">// initialized to &amp;_NSConcreteStackBlock or &amp;_NSConcreteGlobalBlock</span></div><div class="line"><span class="keyword">int</span> flags;</div><div class="line"><span class="keyword">int</span> reserved;</div><div class="line"><span class="keyword">void</span> (*invoke)(<span class="keyword">void</span> *, ...);</div><div class="line"><span class="keyword">struct</span> Block_descriptor_1 &#123;</div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">int</span> reserved;         <span class="comment">// NULL</span></div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">int</span> size;         <span class="comment">// sizeof(struct Block_literal_1)</span></div><div class="line">    <span class="comment">// optional helper functions</span></div><div class="line">    <span class="keyword">void</span> (*copy_helper)(<span class="keyword">void</span> *dst, <span class="keyword">void</span> *src);     <span class="comment">// IFF (1&lt;&lt;25)</span></div><div class="line">    <span class="keyword">void</span> (*dispose_helper)(<span class="keyword">void</span> *src);             <span class="comment">// IFF (1&lt;&lt;25)</span></div><div class="line">    <span class="comment">// required ABI.2010.3.16</span></div><div class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *signature;                         <span class="comment">// IFF (1&lt;&lt;30)</span></div><div class="line">&#125; *descriptor;</div><div class="line"><span class="comment">// imported variables</span></div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p> isa 证明了 block 也是一个对象，它指向的则为 block 在内存中所属的类型，分别是：</p>
<ul>
<li>NSConcreteStackBlock</li>
<li>NSConcreteGlobalBlock</li>
<li><p>NSConcreteMallocBlock</p>
<p><code>flags</code> 作为一个 bit 位，标示了 block 的一些信息，在block copy的时候会被用到。</p>
</li>
</ul>
<p><code>reserved</code> 为保留参数。</p>
<p><code>invoke</code> 为函数指针。指向具体的实现函数，也就咱们block中实现的方法。</p>
<p><code>descriptor</code> 为block的描述结构体其中里面记录了：</p>
<ul>
<li><code>reserved</code> 和block里面的功能相同，都为保留参数。</li>
<li><code>sizeblock</code> 在内存中所分配的大小</li>
<li><code>copy_helper()</code> 和 <code>dispose_helper()</code> 函数指针是做用于被__block所标记对象在block中的结构体的描述</li>
<li><code>signature</code> 为<code>block</code> 签名域的描述，可为空。<br>下面我们用一个例子来验证上面这个，具体代码如下</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">void</span> (^funOC) (<span class="keyword">void</span>) = ^ &#123;</div><div class="line">        NSLog(@<span class="string">"test"</span>);</div><div class="line">    &#125;;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>通过 Clang 命令 clang -rewrite-objc 我们可以看看上述代码在底层是如何运行的</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">struct</span> <span class="number">__b</span>lock_impl &#123;</div><div class="line">      <span class="keyword">void</span> *isa;</div><div class="line">      <span class="keyword">int</span> Flags;</div><div class="line">      <span class="keyword">int</span> Reserved;</div><div class="line">      <span class="keyword">void</span> *FuncPtr;</div><div class="line">&#125;;</div><div class="line"><span class="keyword">struct</span> <span class="number">__</span>main_block_impl_0 &#123;</div><div class="line">      <span class="keyword">struct</span> <span class="number">__b</span>lock_impl impl;</div><div class="line">      <span class="keyword">struct</span> <span class="number">__</span>main_block_desc_0* Desc;</div><div class="line">      <span class="number">__</span>main_block_impl_0(<span class="keyword">void</span> *fp, <span class="keyword">struct</span> <span class="number">__</span>main_block_desc_0 *desc, <span class="keyword">int</span> flags=<span class="number">0</span>) &#123;</div><div class="line">        impl.isa = &amp;<span class="number">_</span>NSConcreteStackBlock;</div><div class="line">        impl.Flags = flags;</div><div class="line">        impl.FuncPtr = fp;</div><div class="line">        Desc = desc;</div><div class="line">      &#125;</div><div class="line">&#125;;</div><div class="line"><span class="keyword">static</span> <span class="keyword">void</span> <span class="number">__</span>main_block_func_0(<span class="keyword">struct</span> <span class="number">__</span>main_block_impl_0 *<span class="number">__</span>cself) &#123;</div><div class="line">    NSLog((NSString *)&amp;<span class="number">__</span>NSConstantStringImpl__var_folders_32_18gy3n8517v_z8cqqwv51yd80000gp_T_main_3139a8_mi_0);</div><div class="line">&#125;</div><div class="line"><span class="keyword">static</span> <span class="keyword">struct</span> <span class="number">__</span>main_block_desc_0 &#123;</div><div class="line">      <span class="keyword">size_t</span> reserved;</div><div class="line">      <span class="keyword">size_t</span> Block_size;</div><div class="line">&#125; <span class="number">__</span>main_block_desc_0_DATA = &#123; <span class="number">0</span>, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <span class="number">__</span>main_block_impl_0)&#125;;</div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span> </span>&#123;</div><div class="line">    <span class="keyword">void</span> (*funOC) (<span class="keyword">void</span>) = (<span class="keyword">void</span> (*)())&amp;<span class="number">__</span>main_block_impl_0((<span class="keyword">void</span> *)<span class="number">__</span>main_block_func_0, &amp;<span class="number">__</span>main_block_desc_0_DATA);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这些就是我们解析后的代码，可以看出来在 main() 中我们用 OC 实现的代码被转换成了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">void (*funOC) (void) = (void (*)())&amp;__main_block_impl_0((void *)__main_block_func_0, &amp;__main_block_desc_0_DATA);</div></pre></td></tr></table></figure>
<p>而其中的 <code>__main_block_impl_0</code> 就是我们 Block 的真身了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">struct __main_block_impl_0 &#123;</div><div class="line">      struct __block_impl impl;</div><div class="line">      struct __main_block_desc_0* Desc;</div><div class="line">      __main_block_impl_0(void *fp, struct __main_block_desc_0 *desc, int flags=0) &#123;</div><div class="line">        impl.isa = &amp;_NSConcreteStackBlock;</div><div class="line">        impl.Flags = flags;</div><div class="line">        impl.FuncPtr = fp;</div><div class="line">        Desc = desc;</div><div class="line">      &#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>是不是感觉和 Clang关于block的介绍 中的内容有点不一样呢？其实是一样的，首先有一点你要清楚， struct 也就是我们俗称的结构体，它在内存中是没有存储任何信息的，也就是说</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">struct abc &#123;</div><div class="line">    int a;</div><div class="line">    int b;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>和</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">struct abc &#123;</div><div class="line">    struct xx &#123;</div><div class="line">        int a;</div><div class="line">    &#125;;</div><div class="line">    struct yy &#123;</div><div class="line">        int b;</div><div class="line">    &#125;;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>是一样的，这样也就解释了为什么解析出来的代码结构体会跟 Clang 中的有所出入。</p>
<h3 id="为什么可以截获自动变量的值"><a href="#为什么可以截获自动变量的值" class="headerlink" title="为什么可以截获自动变量的值"></a>为什么可以截获自动变量的值</h3><p>上面我们了解了 Block 的底层实现，接下来我们来聊聊 Block 的另一个特性“截获自动变量的值”。依旧，我们从一段代码出发</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span> a = <span class="number">1</span>;</div><div class="line"><span class="keyword">void</span> (^funOC) (<span class="keyword">void</span>) = ^ &#123;</div><div class="line">    NSLog(@<span class="string">"%d"</span>,a);</div><div class="line">&#125;;</div><div class="line">a = <span class="number">2</span>;</div><div class="line">funOC();</div></pre></td></tr></table></figure>
<p>从我们之前提到的 Block 具备“截获自动变量的值”特性，所以这段代码最后打印出来的 a 值是 1。那么我们来看看到底为什么</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">struct</span> <span class="number">__</span>main_block_impl_0 &#123;</div><div class="line">      <span class="keyword">struct</span> <span class="number">__b</span>lock_impl impl;</div><div class="line">      <span class="keyword">struct</span> <span class="number">__</span>main_block_desc_0* Desc;</div><div class="line">      <span class="keyword">int</span> a;   <span class="comment">//这里！！！！</span></div><div class="line">      <span class="number">__</span>main_block_impl_0(<span class="keyword">void</span> *fp, <span class="keyword">struct</span> <span class="number">__</span>main_block_desc_0 *desc, <span class="keyword">int</span> <span class="number">_</span>a, <span class="keyword">int</span>         flags=<span class="number">0</span>) : a(<span class="number">_</span>a) &#123;</div><div class="line">        impl.isa = &amp;<span class="number">_</span>NSConcreteStackBlock;</div><div class="line">        impl.Flags = flags;</div><div class="line">        impl.FuncPtr = fp;</div><div class="line">        Desc = desc;</div><div class="line">      &#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keyword">void</span> <span class="number">__</span>main_block_func_0(<span class="keyword">struct</span> <span class="number">__</span>main_block_impl_0 *<span class="number">__</span>cself) &#123;</div><div class="line">      <span class="keyword">int</span> a = <span class="number">__</span>cself-&gt;a; <span class="comment">// bound by copy   这里！！！！</span></div><div class="line">    NSLog((NSString *)&amp;<span class="number">__</span>NSConstantStringImpl__var_folders_32_18gy3n8517v_z8cqqwv51yd80000gp_T_main_2e5ba3_mi_0,a);  <span class="comment">//这里！！！！</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keyword">struct</span> <span class="number">__</span>main_block_desc_0 &#123;</div><div class="line">      <span class="keyword">size_t</span> reserved;</div><div class="line">      <span class="keyword">size_t</span> Block_size;</div><div class="line">&#125; <span class="number">__</span>main_block_desc_0_DATA = &#123; <span class="number">0</span>, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <span class="number">__</span>main_block_impl_0)&#125;;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> a = <span class="number">1</span>;</div><div class="line">    <span class="keyword">void</span> (*funOC) (<span class="keyword">void</span>) = (<span class="keyword">void</span> (*)())&amp;<span class="number">__</span>main_block_impl_0((<span class="keyword">void</span> *)<span class="number">__</span>main_block_func_0, &amp;<span class="number">__</span>main_block_desc_0_DATA, a);  <span class="comment">//这里！！！！</span></div><div class="line">    a = <span class="number">2</span>;</div><div class="line">((<span class="keyword">void</span> (*)(<span class="number">__b</span>lock_impl *))((<span class="number">__b</span>lock_impl *)funOC)-&gt;FuncPtr)((<span class="number">__b</span>lock_impl *)funOC);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>有没有发现那个 int a，是的，虽然我们的 Block 并没有声明传入参数，但是在 Block 的实现当中是的的确确将 a 传入了，同时 Block 结构体中也创建了一个 int a 参数用来存储这个 a 参数值，所以当我们 Block 中调用 a 的时候，他就会取出之前存储的 int a 并将其 Log 出来，也就是我们的 1 。</p>
<h3 id="block-到底做了些什么"><a href="#block-到底做了些什么" class="headerlink" title="__block 到底做了些什么"></a>__block 到底做了些什么</h3><p>还是上面那段代码，如果我们在 a 参数前面加个 __block 会怎么样呢？</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">__block int a = 1;</div></pre></td></tr></table></figure>
<p>talk is cheap ，让我们来看看编译器为我们做了些什么</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">struct</span> <span class="number">__B</span>lock_byref_a_0 &#123;</div><div class="line">      <span class="keyword">void</span> *<span class="number">__</span>isa;</div><div class="line">    <span class="number">__B</span>lock_byref_a_0 *<span class="number">__f</span>orwarding;</div><div class="line">     <span class="keyword">int</span> <span class="number">__f</span>lags;</div><div class="line">     <span class="keyword">int</span> <span class="number">__</span>size;</div><div class="line">     <span class="keyword">int</span> a;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="keyword">struct</span> <span class="number">__</span>main_block_impl_0 &#123;</div><div class="line">      <span class="keyword">struct</span> <span class="number">__b</span>lock_impl impl;</div><div class="line">      <span class="keyword">struct</span> <span class="number">__</span>main_block_desc_0* Desc;</div><div class="line">      <span class="number">__B</span>lock_byref_a_0 *a; <span class="comment">// by ref</span></div><div class="line">      <span class="number">__</span>main_block_impl_0(<span class="keyword">void</span> *fp, <span class="keyword">struct</span> <span class="number">__</span>main_block_desc_0 *desc,         <span class="number">__B</span>lock_byref_a_0 *<span class="number">_</span>a, <span class="keyword">int</span> flags=<span class="number">0</span>) : a(<span class="number">_</span>a-&gt;<span class="number">__f</span>orwarding) &#123;</div><div class="line">        impl.isa = &amp;<span class="number">_</span>NSConcreteStackBlock;</div><div class="line">        impl.Flags = flags;</div><div class="line">        impl.FuncPtr = fp;</div><div class="line">        Desc = desc;</div><div class="line">      &#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keyword">void</span> <span class="number">__</span>main_block_func_0(<span class="keyword">struct</span> <span class="number">__</span>main_block_impl_0 *<span class="number">__</span>cself) &#123;</div><div class="line">      <span class="number">__B</span>lock_byref_a_0 *a = <span class="number">__</span>cself-&gt;a; <span class="comment">// bound by ref</span></div><div class="line">    NSLog((NSString *)&amp;<span class="number">__</span>NSConstantStringImpl__var_folders_32_18gy3n8517v_z8cqqwv51yd80000gp_T_main_111197_mi_0,(a-&gt;<span class="number">__f</span>orwarding-&gt;a));</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keyword">void</span> <span class="number">__</span>main_block_copy_0(<span class="keyword">struct</span> <span class="number">__</span>main_block_impl_0*dst, <span class="keyword">struct</span> <span class="number">__</span>main_block_impl_0*src) &#123;</div><div class="line">    <span class="number">_B</span>lock_object_assign((<span class="keyword">void</span>*)&amp;dst-&gt;a, (<span class="keyword">void</span>*)src-&gt;a, <span class="number">8</span><span class="comment">/*BLOCK_FIELD_IS_BYREF*/</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keyword">void</span> <span class="number">__</span>main_block_dispose_0(<span class="keyword">struct</span> <span class="number">__</span>main_block_impl_0*src) &#123;</div><div class="line">    <span class="number">_B</span>lock_object_dispose((<span class="keyword">void</span>*)src-&gt;a, <span class="number">8</span><span class="comment">/*BLOCK_FIELD_IS_BYREF*/</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keyword">struct</span> <span class="number">__</span>main_block_desc_0 &#123;</div><div class="line">      <span class="keyword">size_t</span> reserved;</div><div class="line">      <span class="keyword">size_t</span> Block_size;</div><div class="line">      <span class="keyword">void</span> (*copy)(<span class="keyword">struct</span> <span class="number">__</span>main_block_impl_0*, <span class="keyword">struct</span> <span class="number">__</span>main_block_impl_0*);</div><div class="line">      <span class="keyword">void</span> (*dispose)(<span class="keyword">struct</span> <span class="number">__</span>main_block_impl_0*);</div><div class="line">&#125; <span class="number">__</span>main_block_desc_0_DATA = &#123; <span class="number">0</span>, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <span class="number">__</span>main_block_impl_0), <span class="number">__</span>main_block_copy_0, <span class="number">__</span>main_block_dispose_0&#125;;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span> </span>&#123;</div><div class="line">    <span class="number">__</span>attribute__((<span class="number">__b</span>locks__(byref))) <span class="number">__B</span>lock_byref_a_0 a = &#123;(<span class="keyword">void</span>*)<span class="number">0</span>,(<span class="number">__B</span>lock_byref_a_0 *)&amp;a, <span class="number">0</span>, <span class="keyword">sizeof</span>(<span class="number">__B</span>lock_byref_a_0), <span class="number">1</span>&#125;;</div><div class="line">    <span class="keyword">void</span> (*funOC) (<span class="keyword">void</span>) = (<span class="keyword">void</span> (*)())&amp;<span class="number">__</span>main_block_impl_0((<span class="keyword">void</span> *)<span class="number">__</span>main_block_func_0, &amp;<span class="number">__</span>main_block_desc_0_DATA, (<span class="number">__B</span>lock_byref_a_0 *)&amp;a, <span class="number">570425344</span>);</div><div class="line">    (a<span class="number">.__f</span>orwarding-&gt;a) = <span class="number">2</span>;</div><div class="line">    ((<span class="keyword">void</span> (*)(<span class="number">__b</span>lock_impl *))((<span class="number">__b</span>lock_impl *)funOC)-&gt;FuncPtr)((<span class="number">__b</span>lock_impl *)funOC);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>你会发现当我们用 <strong>block 标记一个对象参数的时候，编译器会给我们做很多的工作，其中多出来了 `</strong>Block_byref_a_0<code>，</code><strong>main_block_copy_0()<code>，</code></strong>main_block_dispose_0()` 这三个东西，下面我们就来分析一下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">struct</span> <span class="number">__B</span>lock_byref_a_0 &#123;</div><div class="line">      <span class="keyword">void</span> *<span class="number">__</span>isa;</div><div class="line">    <span class="number">__B</span>lock_byref_a_0 *<span class="number">__f</span>orwarding;</div><div class="line">     <span class="keyword">int</span> <span class="number">__f</span>lags;</div><div class="line">     <span class="keyword">int</span> <span class="number">__</span>size;</div><div class="line">     <span class="keyword">int</span> a;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>当我们使用 <strong>block int a 针对参数 a 进行标示的时候，编译器会用这个结构体为我们创建一个指向 a 参数地址的结构体指针 `</strong>Block_byref_a_0` 的对象,同时插入了 Block 对象的结构体中。所以说为什么我们通过 __block 标识符可以在内部访问外部变量，就是这个原因。</p>
<p>那么我们再来看看另外两个函数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">static</span> <span class="keyword">void</span> <span class="number">__</span>main_block_copy_0(<span class="keyword">struct</span> <span class="number">__</span>main_block_impl_0*dst, <span class="keyword">struct</span> <span class="number">__</span>main_block_impl_0*src) &#123;</div><div class="line">    <span class="number">_B</span>lock_object_assign((<span class="keyword">void</span>*)&amp;dst-&gt;a, (<span class="keyword">void</span>*)src-&gt;a, <span class="number">8</span><span class="comment">/*BLOCK_FIELD_IS_BYREF*/</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>新增的这个函数，其目的是用来完成当我们针对这个 Block 对象进行 copy 操作的时候，一并复制这个 Block 对象内的参数，也就是我们的 a 所使用的。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">static</span> <span class="keyword">void</span> <span class="number">__</span>main_block_dispose_0(<span class="keyword">struct</span> <span class="number">__</span>main_block_impl_0*src) &#123;</div><div class="line">    <span class="number">_B</span>lock_object_dispose((<span class="keyword">void</span>*)src-&gt;a, <span class="number">8</span><span class="comment">/*BLOCK_FIELD_IS_BYREF*/</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这个里面包含了一个 C 函数 <code>_Block_object_dispose()</code> ，这个函数在 Apple 的 <code>runtime.c</code> 找到了源码</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span> <span class="number">_B</span>lock_object_dispose(<span class="keyword">const</span> <span class="keyword">void</span> *object, <span class="keyword">const</span> <span class="keyword">int</span> flags) &#123;</div><div class="line">    <span class="comment">//printf("_Block_object_dispose(%p, %x)\n", object, flags);</span></div><div class="line">    <span class="keyword">if</span> (flags &amp; BLOCK_FIELD_IS_BYREF)  &#123;</div><div class="line">        <span class="comment">// get rid of the __block data structure held in a Block</span></div><div class="line">        <span class="number">_B</span>lock_byref_release(object);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ((flags &amp; (BLOCK_FIELD_IS_BLOCK|BLOCK_BYREF_CALLER)) == BLOCK_FIELD_IS_BLOCK) &#123;</div><div class="line">        <span class="comment">// get rid of a referenced Block held by this Block</span></div><div class="line">        <span class="comment">// (ignore __block Block variables, compiler doesn't need to call us)</span></div><div class="line">        <span class="number">_B</span>lock_destroy(object);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ((flags &amp; (BLOCK_FIELD_IS_WEAK|BLOCK_FIELD_IS_BLOCK|BLOCK_BYREF_CALLER)) == BLOCK_FIELD_IS_OBJECT) &#123;</div><div class="line">        <span class="comment">// get rid of a referenced object held by this Block</span></div><div class="line">        <span class="comment">// (ignore __block object variables, compiler doesn't need to call us)</span></div><div class="line">        <span class="number">_B</span>lock_release_object(object);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>从上面的函数我们就带盖能了解到，这个是用作 release Block 对象时所调用，用来释放 Block 对象内的其他参数的。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>Block 里面值得我们研究的还有很多，如果有机会还会对 Block 在内存中的情况做一探究。还是那句话知其然还要知其所以然，深入了解 OC 但中的一些底层会很好的有利于我们在开发当中遇到的问题的扫盲。</p>
</div><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a data-url="http://yoursite.com/2015/09/06/深入了解-iOS-中的-Block/" data-id="cis7dlg2d000tmmu5w4y2gzak" class="article-share-link">分享到</a><div class="tags"></div><div class="post-nav"><a href="/2015/09/16/Python-爬虫学习（一）/" class="pre">Python 爬虫学习（一）</a><a href="/2015/08/20/在这个特殊的日子，我们来聊聊-KVO-吧/" class="next">在这个特殊的日子，我们来聊聊 KVO 吧</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Python/">Python</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/iOS/">iOS</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/杂感/">杂感</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最新文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2016/02/21/Apple-pay-体验报告/">Apple pay 体验报告</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/12/29/2015-终总结和-2016-的-flag/">2015 终总结和 2016 的 flag</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/10/22/Scrapy-爬虫学习中不可或缺的利器/">Scrapy 爬虫学习中不可或缺的利器</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/09/28/Python-爬虫学习（三）/">Python 爬虫学习（三）</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/09/18/Python-爬虫学习（二）/">Python 爬虫学习（二）</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/09/16/Python-爬虫学习（一）/">Python 爬虫学习（一）</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/09/06/深入了解-iOS-中的-Block/">深入了解 iOS 中的 Block</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/08/20/在这个特殊的日子，我们来聊聊-KVO-吧/">在这个特殊的日子，我们来聊聊 KVO 吧</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/08/18/CodeSign和App的爱恨情仇/">CodeSign和App的爱恨情仇</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/08/06/iOS补漏和拾遗，从BAT的面试题出发（二）/">iOS补漏和拾遗，从BAT的面试题出发（二）</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="https://github.com/KepenJ" title="Github" target="_blank">Github</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">© <a href="/." rel="nofollow">Log'K'.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="/css/jquery.fancybox.css?v=0.0.0"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>